<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048 Spiel</title>
    <style>
        @keyframes levelUp {
            0% { transform: scale(1); opacity: 0; }
            20% { transform: scale(1.5); opacity: 1; }
            80% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #faf8ef;
            color: #776e65;
        }
        #game-container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 30px;
            max-width: 1200px;
            padding: 20px;
        }
        .game-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-gap: 15px;
            background-color: #bbada0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .tile {
            width: 100px;
            height: 100px;
            background-color: #cdc1b4;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            font-weight: bold;
            color: #776e65;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: scale(1);
        }
        .tile.new {
            animation: appear 0.2s;
        }
        .tile.merge {
            animation: pop 0.2s;
        }
        @keyframes appear {
            0% { opacity: 0; transform: scale(0); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes pop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .tile-2 { background-color: #eee4da; }
        .tile-4 { background-color: #ede0c8; }
        .tile-8 { background-color: #f2b179; color: #f9f6f2; }
        .tile-16 { background-color: #f59563; color: #f9f6f2; }
        .tile-32 { background-color: #f67c5f; color: #f9f6f2; }
        .tile-64 { background-color: #f65e3b; color: #f9f6f2; }
        .tile-128 { 
            background-color: #edcf72; 
            color: #f9f6f2;
            font-size: 32px;
            box-shadow: 0 0 10px rgba(243, 215, 116, 0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        .tile-256 { 
            background-color: #edcc61; 
            color: #f9f6f2;
            font-size: 32px;
            box-shadow: 0 0 10px rgba(243, 215, 116, 0.6), inset 0 0 0 1px rgba(255, 255, 255, 0.15);
        }
        .tile-512 { 
            background-color: #edc850; 
            color: #f9f6f2;
            font-size: 32px;
            box-shadow: 0 0 10px rgba(243, 215, 116, 0.7), inset 0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        .tile-1024 { 
            background-color: #edc53f; 
            color: #f9f6f2;
            font-size: 28px;
            box-shadow: 0 0 10px rgba(243, 215, 116, 0.8), inset 0 0 0 1px rgba(255, 255, 255, 0.25);
        }
        .tile-2048 { 
            background-color: #edc22e; 
            color: #f9f6f2;
            font-size: 28px;
            box-shadow: 0 0 10px rgba(243, 215, 116, 1), inset 0 0 0 1px rgba(255, 255, 255, 0.3);
        }
        .tile-super {
            background-color: #3c3a32;
            color: #f9f6f2;
            font-size: 24px;
        }
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
        }
        .score-container, .best-container, .level-container {
            position: relative;
            background: #bbada0;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            text-align: center;
            font-weight: bold;
            min-width: 120px;
        }
        .level-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .score-title, .best-title, .level-title {
            font-size: 16px;
            color: #eee4da;
        }
        .score-value, .best-value, .level-value {
            font-size: 24px;
        }
        .level-badge {
            position: absolute;
            left: 0;
            right: 0;
            top: -40px;
            margin: auto;
            width: auto;
            text-align: center;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 10;
            opacity: 0;
            pointer-events: none;
        }
        
        .level-badge.start {
            background: #4CAF50;
            color: white;
            animation: levelUp 3s ease-in-out;
        }
        
        .level-badge.levelup {
            background: #edcf72;
            color: white;
            animation: levelUp 3s ease-in-out;
        }
        .score-addition {
            position: absolute;
            top: -30px;
            right: 20px;
            color: rgba(119, 110, 101, 0.9);
            font-size: 24px;
            animation: score-addition 0.8s ease-in-out;
            animation-fill-mode: both;
        }
        @keyframes score-addition {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 15px 0;
        }
        button {
            font-family: inherit;
            font-size: 16px;
            font-weight: bold;
            padding: 12px 25px;
            background-color: #8f7a66;
            color: #f9f6f2;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #9f8b77;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        .gamepad {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            grid-template-rows: repeat(3, 70px);
            gap: 8px;
            padding: 15px;
            background: #bbada0;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .gamepad button {
            width: 70px;
            height: 70px;
            border: 0;
            background: #cdc1b4;
            cursor: pointer;
            position: relative;
            padding: 0;
            box-shadow: 
                inset -4px -4px 0 0 #a99d90,
                inset 4px 4px 0 0 #ede0c8;
        }
        .gamepad button:hover {
            background: #d8cec1;
            transform: translateY(-2px);
        }
        .gamepad button:active {
            background: #bcb0a3;
            box-shadow: 
                inset 4px 4px 0 0 #a99d90,
                inset -4px -4px 0 0 #ede0c8;
            transform: translate(2px, 2px);
        }
        .gamepad button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border: 10px solid transparent;
        }
        .gamepad .up::after {
            border-bottom: 20px solid #776e65;
            border-top: 0;
            margin-top: -5px;
        }
        .gamepad .down::after {
            border-top: 20px solid #776e65;
            border-bottom: 0;
            margin-top: 5px;
        }
        .gamepad .left::after {
            border-right: 20px solid #776e65;
            border-left: 0;
            margin-left: -5px;
        }
        .gamepad .right::after {
            border-left: 20px solid #776e65;
            border-right: 0;
            margin-left: 5px;
        }
        .gamepad .up { grid-area: 1/2/2/3; }
        .gamepad .left { grid-area: 2/1/3/2; }
        .gamepad .right { grid-area: 2/3/3/4; }
        .gamepad .down { grid-area: 3/2/4/3; }
        
        #game-over, #game-won {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(238, 228, 218, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #776e65;
            z-index: 100;
        }
        .hidden {
            display: none !important;
        }
        .message-container {
            background-color: white;
            padding: 30px 50px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .message-container h2 {
            margin-top: 0;
            font-size: 40px;
        }
        .message-container p {
            font-size: 24px;
            margin: 20px 0;
        }
        
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background-color: #eee4da;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            min-width: 280px;
        }
        .stats-container, .help-container, .settings-container {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .stats-container h3, .help-container h3, .settings-container h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #776e65;
            font-size: 18px;
            border-bottom: 1px solid #f2e8dd;
            padding-bottom: 8px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .language-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #8f7a66;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .setting-item {
            margin-bottom: 15px;
        }
        .difficulty-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .difficulty-options button {
            padding: 8px 15px;
            flex: 1;
            font-size: 14px;
        }
        .sound-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        @media (max-width: 1024px) {
            #game-container {
                flex-direction: column;
                padding: 10px;
            }
            .game-content, .side-panel {
                width: 100%;
            }
            .side-panel {
                order: 2;
                margin-top: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .tile {
                width: 80px;
                height: 80px;
                font-size: 30px;
            }
            .tile-128, .tile-256, .tile-512 {
                font-size: 28px;
            }
            .tile-1024, .tile-2048 {
                font-size: 24px;
            }
            .controls-container {
                order: 2;
                width: 100%;
                align-items: center;
            }
        }
        
        @media (max-width: 480px) {
            .tile {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            .tile-128, .tile-256, .tile-512 {
                font-size: 22px;
            }
            .tile-1024, .tile-2048 {
                font-size: 18px;
            }
            .button-container {
                flex-direction: column;
                gap: 10px;
            }
            button {
                width: 100%;
            }
            .gamepad {
                grid-template-columns: repeat(3, 60px);
                grid-template-rows: repeat(3, 60px);
            }
            .gamepad button {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="game-content">
            <div class="game-info">
                <div class="score-container">
                    <div class="score-title">PUNKTZAHL</div>
                    <div class="score-value" id="score-value">0</div>
                    <div class="score-addition" id="score-addition"></div>
                </div>
                <div class="level-container">
                    <div class="level-title">LEVEL</div>
                    <div class="level-value" id="level-value">1</div>
                    <div class="level-badge" id="level-badge">LEVEL UP!</div>
                </div>
                <div class="best-container">
                    <div class="best-title">BESTLEISTUNG</div>
                    <div class="best-value" id="high-score-value">0</div>
                </div>
            </div>
            <div class="button-container">
                <button id="new-game">Neues Spiel</button>
                <button id="undo">Rückgängig</button>
            </div>
            <div id="game-board"></div>
            <div class="controls-container">
                <div class="gamepad">
                    <button class="up" title="Nach oben"></button>
                    <button class="left" title="Nach links"></button>
                    <button class="right" title="Nach rechts"></button>
                    <button class="down" title="Nach unten"></button>
                </div>
            </div>
        </div>
        
        <div class="side-panel">
            <div class="language-toggle">
                <span>Deutsch</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="language-toggle">
                    <span class="slider"></span>
                </label>
                <span>English</span>
            </div>
            
            <div class="stats-container">
                <h3 id="stats-title">Statistiken</h3>
                <div class="stat-item">
                    <span id="games-played-label">Spiele gespielt:</span>
                    <span id="games-played">0</span>
                </div>
                <div class="stat-item">
                    <span id="wins-label">Gewonnen:</span>
                    <span id="wins">0</span>
                </div>
                <div class="stat-item">
                    <span id="highest-tile-label">Höchster Stein:</span>
                    <span id="highest-tile">0</span>
                </div>
                <div class="stat-item">
                    <span id="avg-score-label">Durchschnittliche Punktzahl:</span>
                    <span id="avg-score">0</span>
                </div>
            </div>
            
            <div class="settings-container">
                <h3 id="settings-title">Einstellungen</h3>
                <div class="setting-item">
                    <div id="difficulty-label">Schwierigkeitsgrad:</div>
                    <div class="difficulty-options">
                        <button id="easy-mode">Leicht</button>
                        <button id="normal-mode">Normal</button>
                        <button id="hard-mode">Schwer</button>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="sound-toggle">
                        <label for="sound-toggle" id="sound-label">Ton:</label>
                        <input type="checkbox" id="sound-toggle" checked>
                    </div>
                </div>
            </div>
            
            <div class="help-container">
                <h3 id="help-title">Wie man spielt</h3>
                <p id="help-text">Verwende die Pfeiltasten, um alle Steine in eine Richtung zu bewegen. Wenn zwei Steine mit der gleichen Zahl kollidieren, werden sie zu einem Stein mit der Summe vereint. Erreiche den 2048-Stein, um zu gewinnen!</p>
            </div>
        </div>
    </div>
    
    <div id="game-over" class="hidden">
        <div class="message-container">
            <h2 id="game-over-title">Spiel vorbei!</h2>
            <p id="game-over-score">Deine Punktzahl: <span id="final-score">0</span></p>
            <button id="restart">Nochmal spielen</button>
        </div>
    </div>
    
    <div id="game-won" class="hidden">
        <div class="message-container">
            <h2 id="game-won-title">Du hast gewonnen!</h2>
            <p id="game-won-message">Du hast den 2048-Stein erreicht!</p>
            <p id="game-won-score">Punktzahl: <span id="win-score">0</span></p>
            <button id="keep-going">Weiterspielen</button>
            <button id="restart-after-win">Neues Spiel</button>
        </div>
    </div>

    <script>
        class Game2048 {
            constructor() {
                this.board = Array(4).fill().map(() => Array(4).fill(0));
                this.score = 0;
                this.previousScore = 0;
                this.highScore = parseInt(localStorage.getItem('highScore')) || 0;
                this.gameBoard = document.getElementById('game-board');
                this.scoreDisplay = document.getElementById('score-value');
                this.scoreAddition = document.getElementById('score-addition');
                this.highScoreDisplay = document.getElementById('high-score-value');
                this.levelDisplay = document.getElementById('level-value');
                this.levelBadge = document.getElementById('level-badge');
                this.newGameBtn = document.getElementById('new-game');
                this.undoBtn = document.getElementById('undo');
                this.gameOverOverlay = document.getElementById('game-over');
                this.gameWonOverlay = document.getElementById('game-won');
                this.finalScoreDisplay = document.getElementById('final-score');
                this.winScoreDisplay = document.getElementById('win-score');
                this.restartBtn = document.getElementById('restart');
                this.keepGoingBtn = document.getElementById('keep-going');
                this.restartAfterWinBtn = document.getElementById('restart-after-win');
                this.languageToggle = document.getElementById('language-toggle');
                this.easyModeBtn = document.getElementById('easy-mode');
                this.normalModeBtn = document.getElementById('normal-mode');
                this.hardModeBtn = document.getElementById('hard-mode');
                this.soundToggle = document.getElementById('sound-toggle');
                
                this.previousState = null;
                this.won = false;
                this.over = false;
                this.keepPlaying = false;
                this.isGerman = true;
                this.difficulty = 'normal';
                this.soundEnabled = true;
                this.level = 1;
                this.levelThresholds = [1000, 2000, 4000, 8000];
                this.tileProbabilities = {
                    easy: { 1: 0.9, 2: 0.85, 3: 0.8, 4: 0.75, 5: 0.7 },
                    normal: { 1: 0.85, 2: 0.8, 3: 0.75, 4: 0.7, 5: 0.65 },
                    hard: { 1: 0.8, 2: 0.75, 3: 0.7, 4: 0.65, 5: 0.6 }
                };
                this.gameStats = this.loadStats();
                
                // Sound-Effekte (würden in einer echten Implementierung besser sein)
                this.moveSound = new Audio('data:audio/wav;base64,UklGRngAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAAABMYXZjNTguMTcuMTAxAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
                this.mergeSound = new Audio('data:audio/wav;base64,UklGRngAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAAABMYXZjNTguMTcuMTAxAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
                this.gameOverSound = new Audio('data:audio/wav;base64,UklGRngAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAAABMYXZjNTguMTcuMTAxAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
                this.winSound = new Audio('data:audio/wav;base64,UklGRngAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAAABMYXZjNTguMTcuMTAxAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
                
                this.translations = {
                    'de': {
                        'newGame': 'Neues Spiel',
                        'undo': 'Rückgängig',
                        'score': 'PUNKTZAHL',
                        'bestScore': 'BESTLEISTUNG',
                        'level': 'LEVEL',
                        'levelUp': 'LEVEL UP!',
                        'startMessage': 'LOS GEHT\'S!',
                        'gameOver': 'Spiel vorbei!',
                        'yourScore': 'Deine Punktzahl:',
                        'playAgain': 'Nochmal spielen',
                        'youWon': 'Du hast gewonnen!',
                        'reachedTile': 'Du hast den 2048-Stein erreicht!',
                        'keepGoing': 'Weiterspielen',
                        'stats': 'Statistiken',
                        'gamesPlayed': 'Spiele gespielt:',
                        'wins': 'Gewonnen:',
                        'highestTile': 'Höchster Stein:',
                        'avgScore': 'Durchschnittliche Punktzahl:',
                        'settings': 'Einstellungen',
                        'difficulty': 'Schwierigkeitsgrad:',
                        'easy': 'Leicht',
                        'normal': 'Normal',
                        'hard': 'Schwer',
                        'sound': 'Ton:',
                        'help': 'Wie man spielt',
                        'helpText': 'Verwende die Pfeiltasten, um alle Steine in eine Richtung zu bewegen. Wenn zwei Steine mit der gleichen Zahl kollidieren, werden sie zu einem Stein mit der Summe vereint. Erreiche den 2048-Stein, um zu gewinnen! Mit steigendem Level wird das Spiel schwieriger.'
                    },
                    'en': {
                        'newGame': 'New Game',
                        'undo': 'Undo',
                        'score': 'SCORE',
                        'bestScore': 'BEST',
                        'level': 'LEVEL',
                        'levelUp': 'LEVEL UP!',
                        'startMessage': 'LET\'S GO!',
                        'gameOver': 'Game Over!',
                        'yourScore': 'Your score:',
                        'playAgain': 'Play Again',
                        'youWon': 'You Won!',
                        'reachedTile': 'You reached the 2048 tile!',
                        'keepGoing': 'Keep Going',
                        'stats': 'Statistics',
                        'gamesPlayed': 'Games played:',
                        'wins': 'Wins:',
                        'highestTile': 'Highest tile:',
                        'avgScore': 'Average score:',
                        'settings': 'Settings',
                        'difficulty': 'Difficulty:',
                        'easy': 'Easy',
                        'normal': 'Normal',
                        'hard': 'Hard',
                        'sound': 'Sound:',
                        'help': 'How to Play',
                        'helpText': 'Use the arrow keys to move all tiles in one direction. When two tiles with the same number collide, they merge into one with the sum. Reach the 2048 tile to win! As your level increases, the game becomes more challenging.'
                    }
                };
                
                this.init();
            }

            loadStats() {
                const savedStats = localStorage.getItem('gameStats');
                if (savedStats) {
                    return JSON.parse(savedStats);
                } else {
                    return {
                        gamesPlayed: 0,
                        wins: 0,
                        highestTile: 0,
                        totalScore: 0
                    };
                }
            }

            saveStats() {
                localStorage.setItem('gameStats', JSON.stringify(this.gameStats));
                this.updateStatsDisplay();
            }

            updateStatsDisplay() {
                document.getElementById('games-played').textContent = this.gameStats.gamesPlayed;
                document.getElementById('wins').textContent = this.gameStats.wins;
                document.getElementById('highest-tile').textContent = this.gameStats.highestTile;
                
                const avgScore = this.gameStats.gamesPlayed > 0 
                    ? Math.round(this.gameStats.totalScore / this.gameStats.gamesPlayed) 
                    : 0;
                document.getElementById('avg-score').textContent = avgScore;
            }

            init() {
                this.newGameBtn.addEventListener('click', () => this.resetGame());
                this.undoBtn.addEventListener('click', () => this.undo());
                this.restartBtn.addEventListener('click', () => this.resetGame());
                this.keepGoingBtn.addEventListener('click', () => this.continueGame());
                this.restartAfterWinBtn.addEventListener('click', () => this.resetGame());
                this.languageToggle.addEventListener('change', () => this.toggleLanguage());
                this.easyModeBtn.addEventListener('click', () => this.setDifficulty('easy'));
                this.normalModeBtn.addEventListener('click', () => this.setDifficulty('normal'));
                this.hardModeBtn.addEventListener('click', () => this.setDifficulty('hard'));
                this.soundToggle.addEventListener('change', () => this.toggleSound());
                
                document.addEventListener('keydown', this.handleKeyPress.bind(this));
                this.resetGame();
                this.updateStatsDisplay();
                this.updateUiLanguage();
                this.setDifficulty('normal');
            }

            toggleLanguage() {
                this.isGerman = !this.isGerman;
                this.updateUiLanguage();
            }

            updateUiLanguage() {
                const lang = this.isGerman ? 'de' : 'en';
                const t = this.translations[lang];
                
                // Main UI
                this.newGameBtn.textContent = t.newGame;
                this.undoBtn.textContent = t.undo;
                document.querySelector('.score-title').textContent = t.score;
                document.querySelector('.best-title').textContent = t.bestScore;
                document.querySelector('.level-title').textContent = t.level;
                this.levelBadge.textContent = t.levelUp;
                
                // Game over screen
                document.getElementById('game-over-title').textContent = t.gameOver;
                document.getElementById('game-over-score').innerHTML = `${t.yourScore} <span id="final-score">${this.score}</span>`;
                this.restartBtn.textContent = t.playAgain;
                
                // Win screen
                document.getElementById('game-won-title').textContent = t.youWon;
                document.getElementById('game-won-message').textContent = t.reachedTile;
                document.getElementById('game-won-score').textContent = `${t.yourScore} ${this.score}`;
                this.keepGoingBtn.textContent = t.keepGoing;
                this.restartAfterWinBtn.textContent = t.newGame;
                
                // Side panel
                document.getElementById('stats-title').textContent = t.stats;
                document.getElementById('games-played-label').textContent = t.gamesPlayed;
                document.getElementById('wins-label').textContent = t.wins;
                document.getElementById('highest-tile-label').textContent = t.highestTile;
                document.getElementById('avg-score-label').textContent = t.avgScore;
                
                document.getElementById('settings-title').textContent = t.settings;
                document.getElementById('difficulty-label').textContent = t.difficulty;
                this.easyModeBtn.textContent = t.easy;
                this.normalModeBtn.textContent = t.normal;
                this.hardModeBtn.textContent = t.hard;
                document.getElementById('sound-label').textContent = t.sound;
                
                document.getElementById('help-title').textContent = t.help;
                document.getElementById('help-text').textContent = t.helpText;
            }

            setDifficulty(level) {
                this.difficulty = level;
                this.resetGame();
                
                // Aktiven Button hervorheben
                this.easyModeBtn.style.opacity = level === 'easy' ? '1' : '0.7';
                this.normalModeBtn.style.opacity = level === 'normal' ? '1' : '0.7';
                this.hardModeBtn.style.opacity = level === 'hard' ? '1' : '0.7';
            }

            toggleSound() {
                this.soundEnabled = this.soundToggle.checked;
            }

            playSound(sound) {
                if (this.soundEnabled) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log("Sound konnte nicht abgespielt werden:", e));
                }
            }

            resetGame() {
                this.board = Array(4).fill().map(() => Array(4).fill(0));
                this.score = 0;
                this.previousScore = 0;
                this.won = false;
                this.over = false;
                this.keepPlaying = false;
                this.level = 1;
                this.levelDisplay.textContent = this.level;
                this.gameOverOverlay.classList.add('hidden');
                this.gameWonOverlay.classList.add('hidden');
                
                // Anfangssteine je nach Schwierigkeitsgrad
                const initialTiles = this.difficulty === 'easy' ? 2 : (this.difficulty === 'hard' ? 1 : 2);
                for (let i = 0; i < initialTiles; i++) {
                    this.addRandomTile();
                }
                
                // "Los geht's"-Nachricht anzeigen
                this.showStartMessage();
                
                this.updateDisplay();
                this.gameStats.gamesPlayed++;
                this.saveStats();
            }
            
            showStartMessage() {
                // Statt "Level Up" eine Startmeldung anzeigen
                const lang = this.isGerman ? 'de' : 'en';
                this.levelBadge.textContent = this.translations[lang].startMessage;
                this.levelBadge.className = 'level-badge start';
                
                // Nach kurzer Verzögerung Animation starten
                setTimeout(() => {
                    this.levelBadge.style.animation = 'none';
                    setTimeout(() => {
                        this.levelBadge.style.animation = 'levelUp 3s ease-in-out';
                    }, 10);
                }, 100);
            }

            addRandomTile() {
                let emptyCells = [];
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        if (this.board[i][j] === 0) {
                            emptyCells.push({i, j});
                        }
                    }
                }
                
                if (emptyCells.length > 0) {
                    const {i, j} = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    
                    // Wahrscheinlichkeit für 2 vs. 4 je nach Schwierigkeitsgrad und Level anpassen
                    let probability = this.tileProbabilities[this.difficulty][this.level] || 
                                     this.tileProbabilities[this.difficulty][Object.keys(this.tileProbabilities[this.difficulty]).length];
                    
                    this.board[i][j] = Math.random() < probability ? 2 : 4;
                    
                    // Neuen Stein für Animation markieren
                    setTimeout(() => {
                        const tiles = this.gameBoard.querySelectorAll('.tile');
                        const index = i * 4 + j;
                        if (tiles[index]) {
                            tiles[index].classList.add('new');
                            setTimeout(() => {
                                tiles[index].classList.remove('new');
                            }, 200);
                        }
                    }, 50);
                }
            }

            updateDisplay() {
                this.gameBoard.innerHTML = '';
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        let tile = document.createElement('div');
                        const value = this.board[i][j];
                        tile.className = `tile${value ? ` tile-${value}` : ''}`;
                        if (value > 2048) {
                            tile.classList.add('tile-super');
                        }
                        tile.textContent = value || '';
                        this.gameBoard.appendChild(tile);
                    }
                }
                this.scoreDisplay.textContent = this.score;
                this.highScoreDisplay.textContent = this.highScore;
                
                // Höchsten Stein in Statistiken aktualisieren
                const highestTile = this.getHighestTile();
                if (highestTile > this.gameStats.highestTile) {
                    this.gameStats.highestTile = highestTile;
                    this.saveStats();
                }
            }

            getHighestTile() {
                let highest = 0;
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        if (this.board[i][j] > highest) {
                            highest = this.board[i][j];
                        }
                    }
                }
                return highest;
            }

            handleKeyPress(event) {
                if (this.over) return;
                
                let moved = false;
                switch(event.key) {
                    case 'ArrowUp':
                        moved = this.move('up');
                        break;
                    case 'ArrowDown':
                        moved = this.move('down');
                        break;
                    case 'ArrowLeft':
                        moved = this.move('left');
                        break;
                    case 'ArrowRight':
                        moved = this.move('right');
                        break;
                }
                
                if (moved) {
                    this.afterMove();
                }
            }

            move(direction) {
                // Aktuellen Zustand für Rückgängig-Funktion speichern
                this.previousState = {
                    board: this.board.map(row => [...row]),
                    score: this.score,
                    won: this.won,
                    keepPlaying: this.keepPlaying
                };
                
                this.previousScore = this.score;
                let moved = false;
                
                if (direction === 'up') {
                    moved = this.moveUp();
                } else if (direction === 'down') {
                    moved = this.moveDown();
                } else if (direction === 'left') {
                    moved = this.moveLeft();
                } else if (direction === 'right') {
                    moved = this.moveRight();
                }
                
                if (moved) {
                    this.playSound(this.moveSound);
                }
                
                return moved;
            }

            afterMove() {
                this.addRandomTile();
                this.updateDisplay();
                
                // Punkteanimation, wenn sich die Punktzahl geändert hat
                if (this.score > this.previousScore) {
                    const addition = this.score - this.previousScore;
                    this.scoreAddition.textContent = '+' + addition;
                    this.scoreAddition.style.display = 'block';
                    setTimeout(() => {
                        this.scoreAddition.style.display = 'none';
                    }, 800);
                }
                
                // Highscore aktualisieren, wenn nötig
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('highScore', this.highScore);
                    this.highScoreDisplay.textContent = this.highScore;
                }
                
                // Level-System: Prüfen, ob ein Level-Up erfolgt ist
                this.checkLevelUp();
                
                // Prüfen, ob der Spieler gewonnen hat (2048 erreicht)
                if (!this.won && !this.keepPlaying) {
                    if (this.checkWin()) {
                        this.win();
                    }
                }
                
                // Prüfen, ob das Spiel vorbei ist
                if (this.checkGameOver()) {
                    this.gameOver();
                }
            }
            
            checkLevelUp() {
                const oldLevel = this.level;
                
                // Berechne neues Level basierend auf der Punktzahl
                for (let i = 0; i < this.levelThresholds.length; i++) {
                    if (this.score >= this.levelThresholds[i]) {
                        this.level = i + 2; // +2 weil wir bei Level 1 beginnen und i bei 0
                    } else {
                        break;
                    }
                }
                
                // Wenn sich das Level erhöht hat, zeige Animation
                if (this.level > oldLevel) {
                    this.levelDisplay.textContent = this.level;
                    
                    // Level-Up-Benachrichtigung anzeigen
                    const lang = this.isGerman ? 'de' : 'en';
                    this.levelBadge.textContent = this.translations[lang].levelUp;
                    this.levelBadge.className = 'level-badge levelup';
                    
                    this.levelBadge.style.animation = 'none';
                    setTimeout(() => {
                        this.levelBadge.style.animation = 'levelUp 3s ease-in-out';
                    }, 10);
                    
                    // Sound abspielen
                    this.playSound(this.winSound);
                }
            }

            moveUp() {
                return this.moveVertical((col) => {
                    let newCol = col.filter(x => x !== 0);
                    for (let i = 0; i < newCol.length - 1; i++) {
                        if (newCol[i] === newCol[i+1]) {
                            newCol[i] *= 2;
                            this.score += newCol[i];
                            newCol.splice(i+1, 1);
                            this.playSound(this.mergeSound);
                        }
                    }
                    while (newCol.length < 4) newCol.push(0);
                    return newCol;
                });
            }

            moveDown() {
                return this.moveVertical((col) => {
                    let newCol = col.filter(x => x !== 0);
                    for (let i = newCol.length - 1; i > 0; i--) {
                        if (newCol[i] === newCol[i-1]) {
                            newCol[i] *= 2;
                            this.score += newCol[i];
                            newCol.splice(i-1, 1);
                            this.playSound(this.mergeSound);
                        }
                    }
                    while (newCol.length < 4) newCol.unshift(0);
                    return newCol;
                });
            }

            moveLeft() {
                return this.moveHorizontal((row) => {
                    let newRow = row.filter(x => x !== 0);
                    for (let i = 0; i < newRow.length - 1; i++) {
                        if (newRow[i] === newRow[i+1]) {
                            newRow[i] *= 2;
                            this.score += newRow[i];
                            newRow.splice(i+1, 1);
                            this.playSound(this.mergeSound);
                        }
                    }
                    while (newRow.length < 4) newRow.push(0);
                    return newRow;
                });
            }

            moveRight() {
                return this.moveHorizontal((row) => {
                    let newRow = row.filter(x => x !== 0);
                    for (let i = newRow.length - 1; i > 0; i--) {
                        if (newRow[i] === newRow[i-1]) {
                            newRow[i] *= 2;
                            this.score += newRow[i];
                            newRow.splice(i-1, 1);
                            this.playSound(this.mergeSound);
                        }
                    }
                    while (newRow.length < 4) newRow.unshift(0);
                    return newRow;
                });
            }

            moveVertical(callback) {
                let moved = false;
                for (let i = 0; i < 4; i++) {
                    let originalCol = this.board.map(row => row[i]);
                    let newCol = callback(originalCol);
                    for (let j = 0; j < 4; j++) {
                        if (this.board[j][i] !== newCol[j]) {
                            moved = true;
                            this.board[j][i] = newCol[j];
                        }
                    }
                }
                return moved;
            }

            moveHorizontal(callback) {
                let moved = false;
                for (let i = 0; i < 4; i++) {
                    let originalRow = [...this.board[i]];
                    let newRow = callback(originalRow);
                    if (originalRow.join(',') !== newRow.join(',')) {
                        moved = true;
                        this.board[i] = newRow;
                    }
                }
                return moved;
            }

            checkWin() {
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        if (this.board[i][j] === 2048) {
                            return true;
                        }
                    }
                }
                return false;
            }

            checkGameOver() {
                // Prüfen, ob es leere Zellen gibt
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        if (this.board[i][j] === 0) return false;
                    }
                }
                
                // Prüfen, ob benachbarte Zellen den gleichen Wert haben
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        if (i < 3 && this.board[i][j] === this.board[i+1][j]) return false;
                        if (j < 3 && this.board[i][j] === this.board[i][j+1]) return false;
                    }
                }
                
                return true;
            }

            win() {
                if (!this.won) {
                    this.won = true;
                    this.gameStats.wins++;
                    this.gameStats.totalScore += this.score;
                    this.saveStats();
                    
                    this.winScoreDisplay.textContent = this.score;
                    this.gameWonOverlay.classList.remove('hidden');
                    this.playSound(this.winSound);
                }
            }

            continueGame() {
                this.keepPlaying = true;
                this.gameWonOverlay.classList.add('hidden');
            }

            gameOver() {
                if (!this.over) {
                    this.over = true;
                    this.gameStats.totalScore += this.score;
                    this.saveStats();
                    
                    // Direkte DOM-Manipulation, um sicherzustellen, dass die aktuelle Punktzahl angezeigt wird
                    document.getElementById('final-score').textContent = this.score;
                    
                    this.gameOverOverlay.classList.remove('hidden');
                    this.playSound(this.gameOverSound);
                    
                    console.log("Game Over, final score:", this.score);
                }
            }

            undo() {
                if (this.previousState) {
                    this.board = this.previousState.board.map(row => [...row]);
                    this.score = this.previousState.score;
                    this.won = this.previousState.won;
                    this.keepPlaying = this.previousState.keepPlaying;
                    this.updateDisplay();
                    this.previousState = null;
                }
            }
        }

        const game = new Game2048();
        
        // Gamepad-Steuerung einrichten
        document.querySelectorAll('.gamepad button').forEach(button => {
            ['mousedown', 'touchstart'].forEach(eventType => {
                button.addEventListener(eventType, (e) => {
                    e.preventDefault();
                    const keyEvents = {
                        'up': 'ArrowUp',
                        'down': 'ArrowDown',
                        'left': 'ArrowLeft',
                        'right': 'ArrowRight'
                    };
                    
                    // Richtung aus der Klasse des Buttons ermitteln
                    const direction = button.className;
                    
                    // Tastaturereignis erstellen und auslösen
                    const keyEvent = new KeyboardEvent('keydown', {
                        key: keyEvents[direction]
                    });
                    document.dispatchEvent(keyEvent);
                });
            });
        });
    </script>
</body>
</html>
